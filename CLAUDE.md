# CLAUDE.md - AI Assistant Guide for talos-booter

## Project Overview

**booter** is a containerized PXE boot server that enables automated network booting of Talos Linux machines. It handles DHCP proxy, TFTP, and iPXE script serving to facilitate machine boot initialization, with optional integration to Siderolabs Omni for cluster management.

**Repository:** `github.com/siderolabs/booter`
**License:** Mozilla Public License v2.0
**Go Version:** 1.25.3

## Quick Reference Commands

```bash
# Build executables (both architectures)
make booter

# Run all tests
make unit-tests

# Run all linters
make lint

# Auto-fix formatting issues
make lint-fmt

# Build Docker image
make image-booter

# Regenerate Makefile from .kres.yaml
make rekres

# Check commit conformance
make conformance

# Clean build artifacts
make clean
```

## Directory Structure

```
/
├── cmd/booter/main.go          # Application entry point, CLI setup
├── internal/
│   ├── constants/              # Global constants
│   ├── server/                 # Core server implementation
│   │   ├── config/             # Machine configuration HTTP handler
│   │   ├── dhcp/               # DHCP proxy implementation
│   │   ├── imagefactory/       # Image factory REST client
│   │   ├── ipxe/               # iPXE script handler and binary patching
│   │   ├── machineconfig/      # Talos machine config builder
│   │   ├── omni/               # Omni API integration
│   │   ├── server/             # HTTP server and routing
│   │   ├── tftp/               # TFTP server
│   │   ├── constants/          # Server-specific constants
│   │   ├── options.go          # Server configuration options
│   │   └── server.go           # Main server orchestration
│   ├── util/                   # Utility functions
│   └── version/                # Auto-generated version info
├── hack/                       # Build and utility scripts
├── Dockerfile                  # Multi-stage Docker build
├── Makefile                    # Auto-generated by kres (DO NOT EDIT)
├── .kres.yaml                  # Kres build configuration
├── .golangci.yml               # Linter configuration
└── .conform.yaml               # Commit policy enforcement
```

## Architecture Overview

### Component-Based Design

The server uses a component pattern where independent services run concurrently in an error group:

```go
type component struct {
    run  func(context.Context) error
    name string
}
```

**Main Components:**
- **DHCP Proxy** (`internal/server/dhcp/`) - Responds to PXE boot requests
- **TFTP Server** (`internal/server/tftp/`) - Serves iPXE binaries
- **HTTP Server** (`internal/server/server/`) - Serves iPXE scripts and configs
- **iPXE Handler** (`internal/server/ipxe/`) - Generates boot scripts, patches binaries

### PXE Boot Flow

1. Machine sends DHCP DISCOVER with PXE option
2. DHCP proxy responds with boot filename/server
3. Client downloads iPXE binary via TFTP
4. iPXE binary contains embedded script pointing to HTTP server
5. HTTP handler returns boot script with image factory URL
6. iPXE chains to factory for kernel/initrd

## Code Conventions

### Import Organization

Imports are organized in this order (enforced by gci):
1. Standard library
2. Third-party packages
3. Local module imports

### Error Handling

Always wrap errors with context:
```go
if err != nil {
    return fmt.Errorf("failed to do something: %w", err)
}
```

### Logging

Use structured logging with zap:
```go
logger.Info("message", zap.String("key", value))
logger.Error("failed", zap.Error(err))
```

Component-specific loggers:
```go
logger.With(zap.String("component", "dhcp"))
```

### Formatting Standards

- Maximum line length: 200 characters
- Use `gofumpt` for formatting (run `make lint-fmt` to auto-fix)
- All `.go` files must have MPL v2.0 license headers

## Key Configuration Values

**Server Defaults (from `internal/server/options.go`):**
```go
ImageFactoryBaseURL:    "https://factory.talos.dev"
ImageFactoryPXEBaseURL: "https://pxe.factory.talos.dev"
APIPort:                50084
TalosVersion:           "v1.10.6"
```

**File Paths (from `internal/constants/constants.go`):**
```go
IPXEPath: "/var/lib/ipxe"   // iPXE binaries location
TFTPPath: "/var/lib/tftp"   // TFTP served files
```

## Supported Platforms

**CPU Architectures:**
- amd64 (x86_64)
- arm64 (aarch64)

**Boot Firmware Types:**
- FirmwareX86PC (Legacy BIOS)
- FirmwareX86EFI (x86 UEFI)
- FirmwareARMEFI (ARM64 UEFI)
- FirmwareX86HTTP (x86 HTTP Boot)
- FirmwareARMHTTP (ARM64 HTTP Boot)

## Development Guidelines

### Makefile is Auto-Generated

The `Makefile` is generated by kres from `.kres.yaml`. **Do not edit it directly.** To modify build behavior:
1. Edit `.kres.yaml`
2. Run `make rekres`

### Commit Requirements

Commits must follow these rules (enforced by `.conform.yaml`):
- **DCO sign-off required** (`git commit -s`)
- **GPG signing required**
- **Conventional commit messages** (feat:, fix:, chore:, etc.)
- **MPL v2.0 license headers** on all source files
- **Single commit per PR** (recommended)

### Adding New Dependencies

1. Use `go get` to add the dependency
2. Run `go mod tidy`
3. Dependencies are managed via `go.mod`/`go.sum`

### Testing

```bash
# Run unit tests with race detection
make unit-tests

# Test specific packages
TESTPKGS=./internal/server/... make unit-tests
```

### Linting

```bash
# Run all linters
make lint

# Individual linters
make lint-golangci-lint    # Go code quality
make lint-gofumpt          # Formatting check
make lint-govulncheck      # Vulnerability scan
make lint-markdown         # Documentation
```

## Key Interfaces

### ImageFactoryClient (`internal/server/imagefactory/client.go`)

Interface for image factory operations:
```go
type ImageFactoryClient interface {
    EnsureSchematic(ctx context.Context, extensions []string, extraKernelArgs []string) (string, error)
}
```

### HTTP Handlers

Request handlers follow standard `http.Handler` pattern:
- `GET /ipxe/{init|boot}.ipxe` - iPXE script generation
- `GET /config?u=<uuid>` - Machine configuration (Omni mode)

## Binary Patching

iPXE binaries contain placeholder scripts that are patched at runtime with the server's actual IP/port. This is handled in `internal/server/ipxe/patch.go`:

- Regular EFI binaries: Direct byte replacement
- KPXE binaries: Use `zbin` tool for compressed format

## Environment Variables

When running the container:
- `EXTRA_KERNEL_ARGS` - Additional kernel arguments
- `OMNI_SERVICE_ACCOUNT_KEY` - Omni API authentication
- `OMNI_ENDPOINT` - Omni API endpoint

## Common Development Tasks

### Adding a New Server Component

1. Create package under `internal/server/<component>/`
2. Implement `func Run(ctx context.Context) error`
3. Register in `internal/server/server.go` components slice
4. Add component-specific logger with `zap.String("component", "name")`

### Modifying iPXE Scripts

Templates are in `internal/server/ipxe/ipxe.go`:
- `initScript` - Initial bootstrap script
- `bootScript` - Main boot script with kernel parameters

### Adding New Firmware Support

1. Add constant to `internal/server/dhcp/dhcp.go` FirmwareType
2. Update `ArchFromFirmware()` function
3. Add TFTP file mapping in `internal/server/ipxe/handler.go`

## Troubleshooting

### Build Failures

1. Ensure Go 1.25.3+ is installed
2. Run `go mod download` to fetch dependencies
3. Check `.kres.yaml` for build configuration

### Lint Failures

Most formatting issues can be auto-fixed:
```bash
make lint-fmt
```

For other issues, check `.golangci.yml` for specific linter configurations.

### Docker Build Issues

The Dockerfile uses Siderolabs base images. Ensure you have access to:
- `ghcr.io/siderolabs/ca-certificates`
- `ghcr.io/siderolabs/fhs`
- `ghcr.io/siderolabs/musl`

## Links

- [Talos Linux Documentation](https://www.talos.dev/docs/)
- [Siderolabs Omni](https://omni.siderolabs.com/)
- [Image Factory](https://factory.talos.dev/)
